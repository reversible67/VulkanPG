# GPU 性能优化指南

## 项目信息
- **项目名称**: VulkanPG Path Guiding
- **GPU**: NVIDIA GeForce RTX 3050 Laptop GPU
- **当前性能**: 45.80 ms/frame (23 fps)
- **目标性能**: 60+ fps

---

## 一、当前性能分析

### 1.1 Timing 分解（总计 45.80 ms）

```
阶段                      耗时        占比
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
G-Buffer 生成             0.02 ms     0.04%
路径追踪主循环            39.14 ms    85.4%  ← 主要瓶颈
Composition              0.14 ms     0.31%
Compute (VXPG)           0.16 ms     0.35%
其他                     ~6.3 ms     13.8%
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
总计                     45.80 ms    100%
```

### 1.2 性能瓶颈定位

**主要瓶颈**：路径追踪 Fragment Shader（占用 85%+ 时间）

**计算量来源**：
```
总计算量 = 分辨率 × Sample Count × Max Depth × 复杂度

当前配置：
- 分辨率：1920×1080 = 2,073,600 像素
- Sample Count：4
- Max Depth (Num Bounces)：~5
- VXPG开启：增加体素采样开销

总光线追踪次数 ≈ 2,073,600 × 4 × 5 = 41,472,000 次/帧
```

### 1.3 RTX 3050 Laptop 限制

| 规格 | 数值 | 与桌面版对比 |
|------|------|-------------|
| CUDA Cores | 2048 | 80% (桌面2560) |
| RT Cores | 16 | - |
| 显存 | 4GB GDDR6 | 同 |
| TDP | 35-80W | 桌面130W的50-60% |
| **路径追踪性能** | **约为桌面版60-70%** | - |

**关键限制**：
- ⚠️ 功耗墙：长时间运行会降频
- ⚠️ 移动版性能：低于桌面版30-40%
- ⚠️ 显存限制：4GB对大分辨率+复杂场景紧张

---

## 二、优化方案总览

### 2.1 按难度分类

| 优化方案 | 难度 | 性能提升 | 质量影响 | 修改位置 |
|---------|------|---------|---------|---------|
| **降低分辨率（70%）** | ⭐ | +100% | 无感知 | UI或代码 |
| **降低Num Bounces** | ⭐ | +67% | 轻微 | UI |
| **降低Sample Count** | ⭐ | +100% | 噪点 | UI |
| **关闭Blur** | ⭐ | +5% | 更清晰 | UI |
| **增大体素大小** | ⭐⭐ | +30% | VXPG粗糙 | 代码 |
| **减少VXPG候选数** | ⭐⭐⭐ | +15% | 轻微 | Shader代码 |
| **降低分辨率（50%）** | ⭐⭐ | +300% | 可接受 | 代码 |

### 2.2 推荐组合方案

#### 方案A：质量优先（推荐）
```
目标：保持画质，提升到50+ fps

优化项：
✓ 分辨率降至 70% (1344×756)
✓ Num Bounces: 5 → 3
✓ 体素大小：0.5 → 0.75

预期性能：23 fps → 55 fps (2.4倍)
质量损失：<10%（几乎无感知）
```

#### 方案B：性能优先
```
目标：实现60+ fps流畅体验

优化项：
✓ 分辨率降至 70% (1344×756)
✓ Num Bounces: 5 → 3
✓ Sample Count: 4 → 2
✓ 体素大小：0.5 → 1.0

预期性能：23 fps → 90 fps (3.9倍)
质量损失：20%（轻微噪点）
```

#### 方案C：平衡模式
```
目标：保持分辨率，提升到40+ fps

优化项：
✓ 分辨率保持 1920×1080
✓ Num Bounces: 5 → 3
✓ Sample Count: 4 → 2
✓ 体素大小：0.5 → 1.0

预期性能：23 fps → 45 fps (1.96倍)
质量损失：15%（有噪点但清晰）
```

---

## 三、具体优化步骤

### 3.1 立即优化（无需改代码，5分钟）

#### 步骤1：调整Num Bounces
```
操作：
1. 运行程序
2. UI左侧找到 "Settings" → "Num Bounces"
3. 滑动条调整为 3 （从默认的5或更高）

效果：FPS提升约 67%
      23 fps → 38 fps
```

#### 步骤2：调整Sample Count
```
操作：
1. UI左侧找到 "Sampling" → "Sample Count"
2. 下拉选择 "2" （当前是4）

效果：FPS再提升 100%
      38 fps → 76 fps

注意：会增加噪点，如果不能接受可保持4
```

#### 步骤3：关闭Blur（如果开启）
```
操作：
1. UI左侧找到 "Denoiser" → "Blur"
2. 取消勾选

效果：FPS略微提升，画面更清晰
```

#### 步骤4：验证Russian Roulette开启
```
操作：
1. UI左侧找到 "Russian Roulette"
2. 确保已勾选

作用：提前终止无贡献的路径，节省计算
```

**即时效果**：通过UI调整，立即从 23 fps → 40-80 fps

---

### 3.2 代码优化（需重新编译，30分钟）

#### 优化1：降低分辨率（最有效！）

**文件**：`d:\PG-VXPG\VulkanPG\src\main.cpp`

**修改位置**：`prepare()` 函数中的窗口初始化部分

```cpp
// 查找类似这样的代码（行号可能不同）
settings.width = 1920;
settings.height = 1080;

// 修改为（70%分辨率）
settings.width = 1344;   // 1920 × 0.7
settings.height = 756;   // 1080 × 0.7

// 或更激进（50%分辨率）
settings.width = 960;    // 1920 × 0.5
settings.height = 540;   // 1080 × 0.5
```

**效果**：
- 70%：像素数减少 51% → FPS提升 100%
- 50%：像素数减少 75% → FPS提升 300%

---

#### 优化2：增大VXPG体素大小

**文件**：`d:\PG-VXPG\VulkanPG\src\main.cpp`

**修改位置**：第26行，`PushConstants` 结构体中

```cpp
// 当前代码
struct PushConstants {
    int modelIndex;
    glm::vec3 gridBegin;
    glm::ivec3 gridDim;
    float cellSize = 0.5f;  // ← 修改这里
    // ...
} pushConstants;

// 修改为
float cellSize = 1.0f;   // 体素数减少 8 倍
// 或
float cellSize = 1.5f;   // 体素数减少 27 倍（激进）
```

**原理**：
```
体素总数 = (场景大小 / cellSize)³

cellSize 0.5 → 1.0：体素数减少 (2)³ = 8倍
cellSize 0.5 → 1.5：体素数减少 (3)³ = 27倍
```

**效果**：
- 内存占用减少
- VXPG prepare/reset 更快
- 路径引导略微粗糙（通常可接受）

**性能提升**：约 20-30%

---

#### 优化3：减少VXPG候选体素数量

**文件**：`d:\PG-VXPG\VulkanPG\shaders\pathtracing.frag`

**修改位置**：`sampleVoxel()` 函数，第393行

```glsl
// 当前代码
int sampleVoxel(vec3 shadingPos, vec3 normal, inout uint seed, out float pdf)
{
    const int numSamples = 8;  // ← 修改这里
    float weights[numSamples];
    int indices[numSamples];
    // ...
}

// 修改为
const int numSamples = 4;   // 减半
// 或
const int numSamples = 6;   // 保守减少
```

**原理**：
- 每次VXPG采样随机选择 `numSamples` 个候选体素
- 计算每个候选的权重
- 减少候选数 → 循环次数减少 → 更快

**效果**：
- VXPG采样速度提升 约50%（8→4）
- 质量影响轻微（4个候选通常足够）

**性能提升**：约 10-15%

---

### 3.3 重新编译

```bash
# 1. 保存所有修改的文件

# 2. 重新编译Shader（如果修改了.frag）
cd d:\PG-VXPG\VulkanPG\shaders
# 使用你的编译脚本或手动编译
glslc pathtracing.frag -o pathtracing.frag.spv

# 3. 重新编译C++项目
# 在Visual Studio中：Build → Rebuild Solution
# 或使用CMake等构建系统

# 4. 运行并测试
```

---

## 四、性能提升预测

### 4.1 单项优化效果

| 优化项 | 操作 | 从23fps提升到 | 提升倍数 |
|-------|------|--------------|---------|
| 分辨率70% | 代码 | 46 fps | 2.0× |
| 分辨率50% | 代码 | 92 fps | 4.0× |
| Num Bounces 3 | UI | 38 fps | 1.67× |
| Sample Count 2 | UI | 46 fps | 2.0× |
| cellSize 1.0 | 代码 | 30 fps | 1.3× |
| cellSize 1.5 | 代码 | 34 fps | 1.5× |
| numSamples 4 | Shader | 26 fps | 1.15× |

### 4.2 组合方案效果

#### 推荐组合1：质量优先
```
优化项：
- 分辨率 70% (1344×756)
- Num Bounces 3
- cellSize 0.75

计算：
2.0× × 1.67× × 1.15× = 3.84×

预期 FPS：23 × 3.84 = 88 fps ✓✓✓
实际预期：约 55-70 fps（考虑其他开销）
```

#### 推荐组合2：性能优先
```
优化项：
- 分辨率 70%
- Num Bounces 3
- Sample Count 2
- cellSize 1.0
- numSamples 4

计算：
2.0× × 1.67× × 2.0× × 1.3× × 1.15× = 9.98×

预期 FPS：23 × 9.98 = 230 fps
实际预期：约 100-120 fps（考虑瓶颈）
```

#### 推荐组合3：平衡模式
```
优化项：
- 分辨率保持 1920×1080
- Num Bounces 3
- Sample Count 2
- cellSize 1.0

计算：
1.0× × 1.67× × 2.0× × 1.3× = 4.34×

预期 FPS：23 × 4.34 = 100 fps
实际预期：约 45-55 fps
```

---

## 五、进阶优化方案

### 5.1 自适应渲染质量

**思路**：根据相机移动状态动态调整质量

```cpp
// 在 viewChanged() 或 update() 中添加
bool cameraMoving = (相机速度 > 阈值);

if (cameraMoving) {
    // 移动时降低质量
    uboComposition.sampleCount = 1;
    uboComposition.numBounces = 2;
} else {
    // 静止时提高质量
    uboComposition.sampleCount = 4;
    uboComposition.numBounces = 5;
}
```

**效果**：
- 移动时保持高帧率（流畅）
- 静止时提升质量（清晰）

---

### 5.2 Temporal Accumulation（多帧累积）

**思路**：每帧只用少量样本，多帧累积

```cpp
// 伪代码
if (相机静止) {
    frameAccumulated++;
    currentImage = render(sampleCount = 1);
    finalImage = (previousImage × (frameAccumulated-1) + currentImage) 
                 / frameAccumulated;
} else {
    frameAccumulated = 0;
    finalImage = render(sampleCount = 4);
}
```

**效果**：
- 每帧只需1个样本 → 4倍性能
- 静止100帧 = 100样本质量
- 移动立即切换到实时模式

---

### 5.3 可变分辨率渲染（VRS）

**思路**：中心高分辨率，边缘低分辨率

```
屏幕划分：
┌─────────────────────┐
│   Low    │   Low    │  50% 分辨率
├─────────────────────┤
│ Low │ High │ Low    │  中心100%，边缘50%
├─────────────────────┤
│   Low    │   Low    │
└─────────────────────┘
```

**效果**：
- 总像素数减少约 50%
- 中心区域质量不变
- 边缘模糊不明显（人眼不敏感）

**需要**：Vulkan VRS扩展支持

---

### 5.4 优化体素选择策略

**当前**：完全随机选择8个候选体素

```glsl
// pathtracing.frag - sampleVoxel()
int voxelIdx = int(rnd(seed) * float(totalVoxels));  // 完全随机
```

**优化**：空间局部性优先

```glsl
// 伪代码
vec3 searchCenter = hitPos;  // 从命中点开始
float searchRadius = 5.0;     // 搜索半径

for (int i = 0; i < numSamples; ++i) {
    // 优先选择附近的体素
    vec3 offset = randomInSphere(seed) * searchRadius;
    int voxelIdx = getVoxelAt(searchCenter + offset);
    // ...
}
```

**效果**：
- 更智能的体素选择
- 减少无效采样
- 提升引导质量

---

## 六、调试和监控

### 6.1 性能监控建议

在UI中添加更详细的timing显示：

```cpp
// main.cpp - OnUpdateUIOverlay()
overlay->text("=== Performance ===");
overlay->text(("Total: " + std::to_string(frameTime) + " ms").c_str());
overlay->text(("FPS: " + std::to_string(lastFPS)).c_str());
overlay->text("");
overlay->text("=== Breakdown ===");
overlay->text(("Ray Tracing: " + std::to_string(timings[1]) + " ms").c_str());
overlay->text(("VXPG Compute: " + std::to_string(timings[5] + timings[7]) + " ms").c_str());
overlay->text(("Composition: " + std::to_string(timings[4]) + " ms").c_str());
overlay->text("");
overlay->text("=== Settings ===");
overlay->text(("Resolution: " + std::to_string(width) + "×" + std::to_string(height)).c_str());
overlay->text(("Samples: " + std::to_string(uboComposition.sampleCount)).c_str());
overlay->text(("Bounces: " + std::to_string(uboComposition.numBounces)).c_str());
```

### 6.2 热点分析

使用Nsight Graphics分析：

```bash
# 1. 安装 NVIDIA Nsight Graphics
# 2. 启动Nsight
# 3. Attach到VulkanPG进程
# 4. Capture一帧
# 5. 查看：
#    - GPU Timeline（哪个shader最慢）
#    - Occupancy（GPU利用率）
#    - Memory Usage（显存占用）
```

### 6.3 关键指标

| 指标 | 目标值 | 当前值 | 状态 |
|------|-------|-------|------|
| **FPS** | 60+ | 23 | ❌ 需优化 |
| **帧时间** | <16.67ms | 45.80ms | ❌ |
| **GPU利用率** | 80-95% | ? | 需测量 |
| **显存占用** | <3GB | ? | 需测量 |
| **路径追踪时间** | <10ms | 39ms | ❌ |

---

## 七、故障排除

### 7.1 优化后FPS未提升

**可能原因**：

1. **CPU瓶颈**
   ```
   检查：GPU利用率是否<80%
   解决：减少CPU端计算，优化UI更新频率
   ```

2. **垂直同步限制**
   ```
   检查：FPS卡在60/30
   解决：关闭VSync
   ```

3. **热降频**
   ```
   检查：长时间运行后FPS下降
   解决：改善散热，降低功耗设置
   ```

### 7.2 画质下降明显

**问题**：噪点过多

```
解决方案：
1. 提高 Sample Count（2→4）
2. 启用 Denoiser（OIDN或NLM）
3. 使用 Temporal Accumulation
```

**问题**：VXPG引导失效

```
检查：
1. cellSize是否过大（>2.0）
2. 体素是否累积足够数据
3. probability设置是否合理

解决：
- cellSize降回1.0
- 增加warmup帧数
- 调整probability到0.6-0.8
```

### 7.3 编译错误

**Shader编译失败**

```bash
# 检查Shader语法
glslangValidator pathtracing.frag

# 常见错误：
# 1. 数组大小必须是常量
const int numSamples = 4;  // 正确
int numSamples = 4;        // 错误

# 2. 变量类型不匹配
float x = 1.0;   // 正确
float x = 1;     // 可能警告
```

---

## 八、优化Checklist

### 立即优化（UI调整）
- [ ] Num Bounces 设置为 3
- [ ] Sample Count 设置为 2（可选）
- [ ] 关闭 Blur
- [ ] 验证 Russian Roulette 开启
- [ ] 测试FPS，记录结果

### 代码优化（需编译）
- [ ] 修改分辨率为 1344×756
- [ ] 修改 cellSize 为 1.0
- [ ] 修改 numSamples 为 4
- [ ] 重新编译Shader
- [ ] 重新编译C++项目
- [ ] 测试并记录结果

### 验证和调优
- [ ] 使用Nsight分析瓶颈
- [ ] 测试不同场景的表现
- [ ] 调整参数找到最佳平衡
- [ ] 记录最终配置

---

## 九、推荐配置总结

### RTX 3050 Laptop 最佳配置

```cpp
// ===== UI设置 =====
Num Bounces: 3
Sample Count: 4
Path Guiding: VXPG ✓
NEE: ✓
NEE MIS: ✓
Russian Roulette: ✓
Blur: ✗

// ===== 代码配置 (main.cpp) =====
settings.width = 1344;
settings.height = 756;
float cellSize = 1.0f;

// ===== Shader配置 (pathtracing.frag) =====
const int numSamples = 6;  // 体素候选数

// ===== 预期性能 =====
FPS: 55-70 fps
质量：高（接近原始质量）
显存：<2GB
```

### 极致性能配置（牺牲画质）

```cpp
// ===== UI设置 =====
Num Bounces: 2
Sample Count: 2
其他同上

// ===== 代码配置 =====
settings.width = 960;
settings.height = 540;
float cellSize = 1.5f;
const int numSamples = 4;

// ===== 预期性能 =====
FPS: 100+ fps
质量：中等（明显噪点）
适用：实时演示、快速预览
```

---

## 十、参考资源

### 文档
- [Vulkan Path Tracing Tutorial](https://github.com/GPSnoopy/RayTracingInVulkan)
- [NVIDIA RTX Best Practices](https://developer.nvidia.com/rtx/raytracing/best-practices)
- [Path Guiding in Production](https://www.arnoldrenderer.com/research/path_guiding_in_production/)

### 工具
- **NVIDIA Nsight Graphics**: GPU性能分析
- **RenderDoc**: Vulkan调试工具
- **GPUView**: Windows GPU性能监控

### 相关论文
- "Practical Path Guiding" (Müller et al., 2017)
- "Neural Importance Sampling" (Müller et al., 2019)
- "ReSTIR" (Bitterli et al., 2020)

---

## 十一、版本记录

| 版本 | 日期 | 修改内容 | 性能 |
|------|------|---------|------|
| v1.0 | 2025-11-29 | 初始版本 | 23 fps |
| v1.1 | - | 应用推荐优化 | 目标: 60 fps |

---

## 附录：快速命令参考

```bash
# ===== 编译Shader =====
cd shaders
glslc pathtracing.frag -o pathtracing.frag.spv

# ===== 检查GPU信息 =====
nvidia-smi

# ===== 启动性能监控 =====
# Windows: 任务管理器 → 性能 → GPU

# ===== 查看当前配置 =====
# 运行程序，查看UI左侧面板
```

---

**最后更新**: 2025-11-29  
**适用版本**: VulkanPG VXPG Implementation  
**作者**: AI Assistant  
**测试GPU**: RTX 3050 Laptop (4GB)

---

## 联系和反馈

如有问题或建议，请记录：
1. 当前配置
2. 性能数据
3. 遇到的问题
4. 期望效果

祝优化顺利！🚀
